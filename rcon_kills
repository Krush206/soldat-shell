#!/bin/tcsh -f

setenv kill_count /tmp/kill_count
setenv killer /tmp/killer
: > $kill_count\_check
: > $killer\_list
mkfifo $killer\_clear $killer\_new >& /dev/null
rm -f $killer\_team

echo "$1" # RCON password
echo 'The rcon_kills C shell script has been enabled!'

kill_log:
  setenv kill_log "$<"

if ( { ( echo -n "$kill_log" | grep -qa '^.* joining game.*HWID:.*$' ) } && ! \
  { ( echo -n "$kill_log" | \
  sed -u 's/^\[//;s/].*$//' | grep -Fqxaf $killer\_list ) } && ! \
  { ( echo -n "$kill_log" | \
  sed -u 's/ joining game .*//' | grep -Fqxaf $killer\_list ) } ) then
  echo "$kill_log" | \
  sed -u 's/ joining game .*//' >> $killer\_list
else if ( { ( echo -n "$kill_log" | grep -qa '^.* killed .* with .*$' ) } && \
  { ( echo -n "$kill_log" | \
  sed -u 's/ killed .* with .*$//' | grep -Fqxaf $killer\_list || \
  echo -n "$kill_log" | tee $killer\_team | \
  sed -u 's/^([0-9]) //;s/ killed ([0-9]) .* with .*$//' | grep -Fqxaf $killer\_list ) } && \
  { ( echo -n "$kill_log" | \
  sed -u 's/ with .*$//;s/.* killed //' | grep -Fqxaf $killer\_list || \
  echo -n "$kill_log" | tee $killer\_team | \
  sed -u 's/^([0-9]) .* killed ([0-9]) //;s/ with .*$//' | grep -Fqxaf $killer\_list ) } ) then
  if ( -e $killer\_team ) then
    echo "$kill_log" | \
    sed -u 's/^([0-9]) //;s/ killed ([0-9]) .* with .*$//' | tee $killer >> $kill_count\_check
    echo "$kill_log" | \
    sed -u 's/^([0-9]) .* killed ([0-9]) //;s/ with .*$//' > $killer\_clear &
    grep -Fxavf $killer\_clear $kill_count\_check > $killer\_new &
  else
    echo "$kill_log" | \
    sed -u 's/ killed .* with .*$//' | tee $killer >> $kill_count\_check
    echo "$kill_log" | \
    sed -u 's/ with .*$//;s/.* killed //' > $killer\_clear &
    grep -Fxavf $killer\_clear $kill_count\_check > $killer\_new &
  endif
  tee < $killer\_new > $kill_count\_check
  sort $kill_count\_check | uniq -c | sed -u 's/^ *//' > $kill_count
  if ( { ( echo -n "5 `tee < $killer`" | grep -Fxqaf $kill_count ) } ) then
    tee < $killer | sed -u 's/^/\/say /;s/$/ is a killer\!/'
  else if ( { ( echo -n "8 `tee < $killer`" | grep -Fxqaf $kill_count ) } ) then
    tee < $killer | sed -u 's/^/\/say /;s/$/ is violent\!/'
  else if ( { ( echo -n "11 `tee < $killer`" | grep -Fxqaf $kill_count ) } ) then
    tee < $killer | sed -u 's/^/\/say /;s/$/ is dominating\!/'
  else if ( { ( echo -n "14 `tee < $killer`" | grep -Fxqaf $kill_count ) } ) then
    tee < $killer | sed -u 's/^/\/say /;s/$/ is crazy\!/'
  else if ( { ( echo -n "17 `tee < $killer`" | grep -Fxqaf $kill_count ) } ) then
    tee < $killer | sed -u 's/^/\/say /;s/$/ is taking over\!/'
  else if ( { ( echo -n "20 `tee < $killer`" | grep -Fxqaf $kill_count ) } ) then
    tee < $killer | sed -u 's/^/\/say /;s/$/ is unstoppable\!/'
  else if ( { ( echo -n "22 `tee < $killer`" | grep -Fxqaf $kill_count ) } ) then
    tee < $killer | sed -u 's/^/\/say /;s/$/ is a god\!/'
  else if ( { ( echo -n "25 `tee < $killer`" | grep -Fxqaf $kill_count ) } ) then
    tee < $killer | sed -u 's/^/\/say /;s/$/ is a cheater\!\!/'
  else if ( { ( echo -n "27 `tee < $killer`" | grep -Fxqaf $kill_count ) } ) then
    tee < $killer | sed -u 's/^/\/say /;s/$/, dude, stop it\!\!\!/'
  endif
endif
goto kill_log
