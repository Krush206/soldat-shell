#!/bin/tcsh -f
if (`uname -s` == Linux) then
  setenv sedimp 'sed -i'
else if (`uname -s` == FreeBSD || `uname -s` == NetBSD || \
`uname -s` == DragonFlyBSD || `uname -s` == OpenBSD) then
  setenv sedimp 'sed -i '\'''\'''
endif

setenv bal_ids /tmp/bal_ids
setenv alpha /tmp/alpha
setenv bravo /tmp/bravo
setenv spectators /tmp/spectators
setenv players /tmp/players

echo "$1" # RCON password
rm -rf $players $alpha $bravo >& /dev/null
seq 1 32 > $bal_ids
mkdir $alpha $bravo $players >& /dev/null
echo 'The rcon_balancer C shell script has been enabled!'

bal_log:
  setenv bal_log "$<"

if ( { ( echo -n "$bal_log" | grep -qa '^.* has joined alpha team\.$' ) } ) then
  echo -n "$bal_log" | \
  setenv alpha_io_check "`sed -u 's/ has joined alpha team\.//'`"
  if ( ! { ( grep -Fxqa "$alpha_io_check" $players/* >& /dev/null ) } ) then
    setenv joiner "`sed -nu '/^[0-9]/{p;q;}' $bal_ids`"
    echo "$alpha_io_check" > $players/$joiner
    $sedimp "/^$joiner"\$"/ s/^/Used /" $bal_ids
  endif
  link $players/`grep -FHax "$alpha_io_check" $players/* | \
  sed -u "s/:.*//;s/.*[^0-9]//"` $alpha/`grep -FHax "$alpha_io_check" \
  $players/* | sed -u "s/:.*//;s/.*[^0-9]//"` >& /dev/null
  unlink $bravo/`grep -FHax "$alpha_io_check" $players/* | \
  sed -u "s/:.*//;s/.*[^0-9]//"` >& /dev/null
else if ( { ( echo -n "$bal_log" | grep -qa '^.* has joined bravo team\.$' ) } ) then
  echo -n "$bal_log" | \
  setenv bravo_io_check "`sed -u 's/ has joined bravo team\.//'`"
  if ( ! { ( grep -Fxqa "$bravo_io_check" $players/* >& /dev/null ) } ) then
    setenv joiner "`sed -nu '/^[0-9]/{p;q;}' $bal_ids`"
    echo "$bravo_io_check" > $players/$joiner
    $sedimp "/^$joiner"\$"/ s/^/Used /" $bal_ids
  endif
  link $players/`grep -FHax "$bravo_io_check" $players/* | \
  sed -u "s/:.*//;s/.*[^0-9]//"` $bravo/`grep -FHax "$bravo_io_check" \
  $players/* | sed -u "s/:.*//;s/.*[^0-9]//"` >& /dev/null
  unlink $alpha/`grep -FHax "$bravo_io_check" $players/* | \
  sed -u "s/:.*//;s/.*[^0-9]//"` >& /dev/null
else if ( { ( echo -n "$bal_log" | grep -qa '^.* has joined as spectator$' ) } ) then
  setenv joiner "`sed -nu '/^[0-9]/{p;q;}' $bal_ids`"
  echo -n "$bal_log" | \
  sed -u 's/ has joined as spectator$//' > $players/$joiner
  $sedimp "/^$joiner"\$"/ s/^/Used /" $bal_ids
else if ( { ( echo -n "$bal_log" | grep -qa '^.* has joined spectators\.$' ) } ) then
  echo -n "$bal_log" | \
  setenv spectators_io_check "`sed -u 's/ has joined spectators\.//'`"
  unlink $alpha/`grep -FHax "$spectators_io_check" $players/* | \
  sed -u "s/:.*//;s/.*[^0-9]//"` >& /dev/null
  unlink $bravo/`grep -FHax "$spectators_io_check" $players/* | \
  sed -u "s/:.*//;s/.*[^0-9]//"` >& /dev/null
else if ( { ( echo -n "$bal_log" | grep -qa '^.* has left alpha team\.$' ) } ) then
  echo -n "$bal_log" | \
  setenv alpha_io2_check "`sed -u 's/ has left alpha team\.//'`"
  grep -FHax "$alpha_io2_check" $players/* | \
  $sedimp "/^Used `sed -u 's/:.*//;s/.*[^0-9]//'`"\$"/ s/Used //" $bal_ids
  find /tmp/ -mindepth 2 -name `grep -FHax "$alpha_io2_check" $players/* | \
  sed -u 's/:.*//;s/.*[^0-9]//'` -exec unlink '{}' \; >& /dev/null
else if ( { ( echo -n "$bal_log" | grep -qa '^.* has left bravo team\.$' ) } ) then
  echo -n "$bal_log" | \
  setenv bravo_io2_check "`sed -u 's/ has left bravo team\.//'`"
  grep -FHax "$bravo_io2_check" $players/* | \
  $sedimp "/^Used `sed -u 's/:.*//;s/.*[^0-9]//'`"\$"/ s/Used //" $bal_ids
  find /tmp/ -mindepth 2 -name `grep -FHax "$bravo_io2_check" $players/* | \
  sed -u 's/:.*//;s/.*[^0-9]//'` -exec unlink '{}' \; >& /dev/null
else if ( { ( echo -n "$bal_log" | grep -qa '^.* has left spectators$' ) } ) then
  echo -n "$bal_log" | \
  setenv spectators_io2_check "`sed -u 's/ has left spectators//'`"
  grep -FHax "$spectators_io2_check" $players/* | \
  $sedimp "/^Used `sed -u 's/:.*//;s/.*[^0-9]//'`"\$"/ s/Used //" $bal_ids
  find /tmp/ -mindepth 2 -name `grep -FHax "$spectators_io2_check" $players/* | \
  sed -u 's/:.*//;s/.*[^0-9]//'` -exec unlink '{}' \; >& /dev/null
endif
setenv alpha_count "`find $alpha/ -mindepth 1 | wc -l`"
setenv bravo_count "`find $bravo/ -mindepth 1 | wc -l`"
if ( `dc -e "$alpha_count $bravo_count - p"` >= 2 ) then
  grep -FHax "$alpha_io_check" $players/* | \
  sed -u 's/:.*//;s/.*[^0-9]//' | sed -u 's/^/\/setteam2 /'
  grep -FHax "$alpha_io_check" $players/* | \
  sed -u 's/:.*//;s/.*[^0-9]//' | sed -u 's/^/\/pm / \
  ;s/$/ You may not join this team; teams are unbalanced./'
  unlink $alpha/`grep -FHax "$alpha_io_check" $players/* | \
  sed -u "s/:.*//;s/.*[^0-9]//"` >& /dev/null
else if ( `dc -e "$bravo_count $alpha_count - p"` >= 2 ) then
  grep -FHax "$bravo_io_check" $players/* | \
  sed -u 's/:.*//;s/.*[^0-9]//' | sed -u 's/^/\/setteam1 /'
  grep -FHax "$bravo_io_check" $players/* | \
  sed -u 's/:.*//;s/.*[^0-9]//' | sed -u 's/^/\/pm / \
  ;s/$/ You may not join this team; teams are unbalanced./'
  unlink $bravo/`grep -FHax "$bravo_io_check" $players/* | \
  sed -u "s/:.*//;s/.*[^0-9]//"` >& /dev/null
endif
goto bal_log
